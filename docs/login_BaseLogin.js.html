<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>login/BaseLogin.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/zhuanzhuanfe/fancy-mini" target="_blank" class="menu-item" id="website_link" >GitHub repo</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-0-getStarted.html">setup</a></li><li><a href="tutorial-1-demoProject.html">demo</a></li><li><a href="tutorial-2.1-login.html">[基础能力] 健壮高效的登录机制</a></li><li><a href="tutorial-2.2-navigate.html">[基础能力] 无限层级的路由机制</a></li><li><a href="tutorial-2.3-request.html">[基础能力] 灵活易扩展的请求管理</a></li><li><a href="tutorial-2.4-cookie.html">[基础能力] cookie机制</a></li><li><a href="tutorial-2.5-canvasKit.html">[基础能力] canvas工具集</a></li><li><a href="tutorial-2.6-wxPromise.html">[基础能力] 微信接口Promise化</a></li><li><a href="tutorial-2.7-routeParams.html">[基础能力] 跨页面传参</a></li><li><a href="tutorial-2.8-eventHub.html">[基础能力] 跨页面事件</a></li><li><a href="tutorial-2.9-customEntry.html">[基础能力] 入口构造工具</a></li><li><a href="tutorial-2.a-qrTest.html">[基础能力] 二维码测试工具</a></li><li><a href="tutorial-2.b-rewardedVideoPlayer.html">[基础能力] 激励视频播放器</a></li><li><a href="tutorial-3.1-adaptiveToast.html">[疑难杂症] toast截断问题</a></li><li><a href="tutorial-3.2-textArea.html">[疑难杂症] textarea遮盖浮层问题</a></li><li><a href="tutorial-4.1-dialogCommon.html">[组件库] 通用弹窗</a></li><li><a href="tutorial-4.2-operationGuide.html">[组件库] 新手引导</a></li><li><a href="tutorial-5.1-noConcurrent.html">[工具库] 免并发修饰器</a></li><li><a href="tutorial-5.2-errSafe.html">[工具库] 异常捕获修饰器</a></li><li><a href="tutorial-5.3-compatible.html">[工具库] 快捷兼容修饰器</a></li><li><a href="tutorial-5.4-wepyKit.html">[工具库] wepy框架工具集</a></li><li><a href="tutorial-5.5-operationKit.html">[工具库] 基础操作工具集</a></li></ul><h3>Classes</h3><ul><li><a href="BaseAuth.html">BaseAuth</a><ul class='methods'><li data-type='method'><a href="BaseAuth.html#authLogin">authLogin</a></li><li data-type='method'><a href="BaseAuth.html#beforeAuthLogin">beforeAuthLogin</a></li><li data-type='method'><a href="BaseAuth.html#silentLogin">silentLogin</a></li></ul></li><li><a href="BaseLogin.html">BaseLogin</a><ul class='methods'><li data-type='method'><a href="BaseLogin.html#_appendConfig">_appendConfig</a></li><li data-type='method'><a href="BaseLogin.html#_handleAddOn">_handleAddOn</a></li><li data-type='method'><a href="BaseLogin.html#_handleUserAuth">_handleUserAuth</a></li><li data-type='method'><a href="BaseLogin.html#_init">_init</a></li><li data-type='method'><a href="BaseLogin.html#_saveAnonymousInfo">_saveAnonymousInfo</a></li><li data-type='method'><a href="BaseLogin.html#_saveInfo">_saveInfo</a></li><li data-type='method'><a href="BaseLogin.html#checkLogin">checkLogin</a></li><li data-type='method'><a href="BaseLogin.html#clearLogin">clearLogin</a></li><li data-type='method'><a href="BaseLogin.html#config">config</a></li><li data-type='method'><a href="BaseLogin.html#login">login</a></li><li data-type='method'><a href="BaseLogin.html#logout">logout</a></li><li data-type='method'><a href="BaseLogin.html#makeAssignableMethod">makeAssignableMethod</a></li><li data-type='method'><a href="BaseLogin.html#reLogin">reLogin</a></li></ul></li><li><a href="Cookie.html">Cookie</a><ul class='methods'><li data-type='method'><a href="Cookie.html#.cookieObjToStr">cookieObjToStr</a></li><li data-type='method'><a href="Cookie.html#.cookieStrToObj">cookieStrToObj</a></li><li data-type='method'><a href="Cookie.html#.mergeCookieStr">mergeCookieStr</a></li><li data-type='method'><a href="Cookie.html#get">get</a></li><li data-type='method'><a href="Cookie.html#getCookie">getCookie</a></li><li data-type='method'><a href="Cookie.html#set">set</a></li><li data-type='method'><a href="Cookie.html#setCookie">setCookie</a></li></ul></li><li><a href="EventHub.html">EventHub</a><ul class='methods'><li data-type='method'><a href="EventHub.html#notify">notify</a></li><li data-type='method'><a href="EventHub.html#subscribe">subscribe</a></li></ul></li><li><a href="History.html">History</a><ul class='methods'><li data-type='method'><a href="History.html#back">back</a></li><li data-type='method'><a href="History.html#config">config</a></li><li data-type='method'><a href="History.html#doCorrection">doCorrection</a></li><li data-type='method'><a href="History.html#getRoute">getRoute</a></li><li data-type='method'><a href="History.html#open">open</a></li><li data-type='method'><a href="History.html#replace">replace</a></li><li data-type='method'><a href="History.html#savePage">savePage</a></li></ul></li><li><a href="LoginPlugin.html">LoginPlugin</a><ul class='methods'><li data-type='method'><a href="LoginPlugin.html#requestWithLogin">requestWithLogin</a></li></ul></li><li><a href="Navigator.html">Navigator</a><ul class='members'><li data-type='member'><a href="Navigator.html#.history">history</a></li></ul><ul class='methods'><li data-type='method'><a href="Navigator.html#.config">config</a></li><li data-type='method'><a href="Navigator.html#.navigateBack">navigateBack</a></li><li data-type='method'><a href="Navigator.html#.navigateTo">navigateTo</a></li><li data-type='method'><a href="Navigator.html#.onPageUnload">onPageUnload</a></li><li data-type='method'><a href="Navigator.html#.redirectTo">redirectTo</a></li><li data-type='method'><a href="Navigator.html#.reLaunch">reLaunch</a></li><li data-type='method'><a href="Navigator.html#.switchTab">switchTab</a></li></ul></li><li><a href="Requester.html">Requester</a><ul class='methods'><li data-type='method'><a href="Requester.html#makeAssignableMethod">makeAssignableMethod</a></li><li data-type='method'><a href="Requester.html#registerToThis">registerToThis</a></li><li data-type='method'><a href="Requester.html#request">request</a></li></ul></li><li><a href="RewardedVideoPlayer.html">RewardedVideoPlayer</a><ul class='methods'><li data-type='method'><a href="RewardedVideoPlayer.html#handlePageChange">handlePageChange</a></li><li data-type='method'><a href="RewardedVideoPlayer.html#load">load</a></li><li data-type='method'><a href="RewardedVideoPlayer.html#onLoadStateChange">onLoadStateChange</a></li><li data-type='method'><a href="RewardedVideoPlayer.html#play">play</a></li></ul></li><li><a href="RouteParams.html">RouteParams</a><ul class='methods'><li data-type='method'><a href="RouteParams.html#clearBackFrom">clearBackFrom</a></li><li data-type='method'><a href="RouteParams.html#clearOpenFrom">clearOpenFrom</a></li><li data-type='method'><a href="RouteParams.html#getBackFromData">getBackFromData</a></li><li data-type='method'><a href="RouteParams.html#getBackFromRoute">getBackFromRoute</a></li><li data-type='method'><a href="RouteParams.html#getOpenFromData">getOpenFromData</a></li><li data-type='method'><a href="RouteParams.html#getOpenFromRoute">getOpenFromRoute</a></li><li data-type='method'><a href="RouteParams.html#setBackFromData">setBackFromData</a></li><li data-type='method'><a href="RouteParams.html#setOpenFromData">setOpenFromData</a></li></ul></li><li><a href="WechatAuth.html">WechatAuth</a><ul class='methods'><li data-type='method'><a href="WechatAuth.html#authLogin">authLogin</a></li><li data-type='method'><a href="WechatAuth.html#beforeAuthLogin">beforeAuthLogin</a></li><li data-type='method'><a href="WechatAuth.html#loginByWxAuth">loginByWxAuth</a></li><li data-type='method'><a href="WechatAuth.html#loginByWxSilent">loginByWxSilent</a></li><li data-type='method'><a href="WechatAuth.html#silentLogin">silentLogin</a></li><li data-type='method'><a href="WechatAuth.html#wxLogin">wxLogin</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-canvasKit.html">canvasKit</a><ul class='methods'><li data-type='method'><a href="module-canvasKit.html#.aspectFill">aspectFill</a></li><li data-type='method'><a href="module-canvasKit.html#.borderRadius">borderRadius</a></li><li data-type='method'><a href="module-canvasKit.html#.ellipsisStr">ellipsisStr</a></li><li data-type='method'><a href="module-canvasKit.html#.fillText">fillText</a></li><li data-type='method'><a href="module-canvasKit.html#.rounded">rounded</a></li><li data-type='method'><a href="module-canvasKit.html#.strLenGraphic">strLenGraphic</a></li></ul></li><li><a href="module-decorator_compatible.html">decorator/compatible</a><ul class='methods'><li data-type='method'><a href="module-decorator_compatible.html#.supportWXCallback">supportWXCallback</a></li></ul></li><li><a href="module-decorator_errSafe.html">decorator/errSafe</a><ul class='methods'><li data-type='method'><a href="module-decorator_errSafe.html#.errSafe">errSafe</a></li><li data-type='method'><a href="module-decorator_errSafe.html#.withErrToast">withErrToast</a></li></ul></li><li><a href="module-decorator_noConcurrent.html">decorator/noConcurrent</a><ul class='methods'><li data-type='method'><a href="module-decorator_noConcurrent.html#.makeMutex">makeMutex</a></li><li data-type='method'><a href="module-decorator_noConcurrent.html#.makeNoConcurrent">makeNoConcurrent</a></li><li data-type='method'><a href="module-decorator_noConcurrent.html#.mergingStep">mergingStep</a></li><li data-type='method'><a href="module-decorator_noConcurrent.html#.noConcurrent">noConcurrent</a></li><li data-type='method'><a href="module-decorator_noConcurrent.html#.singleAisle">singleAisle</a></li></ul></li><li><a href="module-decorators.html">decorators</a></li><li><a href="module-operationKit.html">operationKit</a><ul class='methods'><li data-type='method'><a href="module-operationKit.html#.appendUrlParam">appendUrlParam</a></li><li data-type='method'><a href="module-operationKit.html#.compareVersion">compareVersion</a></li><li data-type='method'><a href="module-operationKit.html#.deepAssign">deepAssign</a></li><li data-type='method'><a href="module-operationKit.html#.deepClone">deepClone</a></li><li data-type='method'><a href="module-operationKit.html#.deepEqual">deepEqual</a></li><li data-type='method'><a href="module-operationKit.html#.delay">delay</a></li><li data-type='method'><a href="module-operationKit.html#.isNonEmptyObject">isNonEmptyObject</a></li><li data-type='method'><a href="module-operationKit.html#.isNonNullObject">isNonNullObject</a></li><li data-type='method'><a href="module-operationKit.html#.makeAssignableMethod">makeAssignableMethod</a></li><li data-type='method'><a href="module-operationKit.html#.padStart">padStart</a></li><li data-type='method'><a href="module-operationKit.html#.parseInlineStyle">parseInlineStyle</a></li><li data-type='method'><a href="module-operationKit.html#.peerAssign">peerAssign</a></li><li data-type='method'><a href="module-operationKit.html#.queryRect">queryRect</a></li><li data-type='method'><a href="module-operationKit.html#.semanticRemainTime">semanticRemainTime</a></li><li data-type='method'><a href="module-operationKit.html#.toAbsolutePath">toAbsolutePath</a></li><li data-type='method'><a href="module-operationKit.html#.toInlineStyle">toInlineStyle</a></li></ul></li><li><a href="module-wepyKit.html">wepyKit</a><ul class='members'><li data-type='member'><a href="module-wepyKit.html#.NavRefine">NavRefine</a></li></ul><ul class='methods'><li data-type='method'><a href="module-wepyKit.html#.pageRestoreHandler">pageRestoreHandler</a></li><li data-type='method'><a href="module-wepyKit.html#.registerPageHook">registerPageHook</a></li><li data-type='method'><a href="module-wepyKit.html#.registerToThis">registerToThis</a></li><li data-type='method'><a href="module-wepyKit.html#~dataRestoreWx2Wepy">dataRestoreWx2Wepy</a></li></ul></li><li><a href="module-wxPromise.html">wxPromise</a><ul class='members'><li data-type='member'><a href="module-wxPromise.html#.wxPromise">wxPromise</a></li><li data-type='member'><a href="module-wxPromise.html#.wxResolve">wxResolve</a></li></ul><ul class='methods'><li data-type='method'><a href="module-wxPromise.html#.customWxPromisify">customWxPromisify</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#ReqRes">ReqRes</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">login/BaseLogin.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {deepClone, makeAssignableMethod, peerAssign} from '../operationKit';
import {mergingStep, errSafe} from '../decorators';

/**
 * 登录模块
 */
@requireConfig //确保调用API时已完成模块配置
class BaseLogin {
  //配置，格式参见config函数
  _configOptions = {};
  
  //数据（长期数据，会被存储到storage中）
  _loginInfo = {
    userInfo: {}, //用户信息
    isLogin: false, //是否已登录
    expireTime: -1, //过期时间，相对1970年的绝对毫秒数，-1表示长期有效
    authType: '', //使用的验证方式
    anonymousInfo: {}, //匿名信息（登录成功前使用的临时标识，成功后继续关联）
  };
  
  //状态（短期数据，仅本次会话使用）
  _stateInfo = {
    isConfigReady: false, //是否已完成模块配置
  };

  /**
   * 构造函数
   * @param {object} [configOptions] 配置项，参见{@link BaseLogin#config}
   */
  constructor(configOptions){
    configOptions &amp;&amp; this.config(configOptions);
  }

  /**
   * 模块配置
   * @param {Object} configOptions 
   * @param {String} [configOptions.loginInfoStorage] 登录相关信息存储到storage时使用的key
   * @param {Requester} configOptions.requester 请求管理器
   * @param {Function} [configOptions.onUserAuthFailed] 钩子函数，获取用户授权信息失败时触发
   * @param {Function} [configOptions.onUserAuthSucceeded] 钩子函数，获取用户授权信息成功时触发
   * @param {Function} [configOptions.onNewlyLogin] 钩子函数，刚刚登录成功时触发（未登录=>已登录）
   * @param {BaseLogin~OnLoginFailed} [configOptions.onLoginFailed] 钩子函数，登录失败时触发
   * @param {Object.&lt;string, BaseAuth>} configOptions.authEngineMap 鉴权器映射表
        key为登录方式，value为对应的鉴权器
        e.g. {
          'wechat' : new WechatAuth(), //微信登录，WechatAuth应继承于BaseAuth
          'phone' : new PhoneAuth(), //手机号登录，PhoneAuth应继承于BaseAuth
        }
   * @param {String} configOptions.defaultAuthType 默认登录方式
   * @param {BaseLogin~UserAuthHandler} configOptions.userAuthHandler 授权交互处理函数，负责跟用户交互，收集鉴权所需信息
   * @param {BaseLogin~LoginStepAddOn} [configOptions.loginStepAddOn] 登录流程自定义附加步骤，会在正常登录流程执行成功时调用，并根据其处理结果生成最终登录结果
   */
  config(configOptions){
    //参数校验
    const necessaryFields = ['userAuthHandler', 'authEngineMap', 'defaultAuthType', 'requester'];
    for (let field of necessaryFields) {
      if (configOptions[field] === undefined) {
        console.error('[Login] config, 必填参数缺失：', field);
        return;
      }
    }
    
    //参数处理
    const defaultOpts = {
      loginInfoStorage: '__loginInfo',
      
      requester: null,
      
      onUserAuthFailed: null,
      onUserAuthSucceeded: null,
      onNewlyLogin: null,
      onLoginFailed(res, {failAction}){
        switch (failAction) { //调用方希望的失败处理方式
          case 'auto': //自动处理
            wx.showToast({
              title: res.toastMsg || '登录失败',
              image: '/images/tipfail.png',
              duration: 3000
            });
            break;
          case 'none': //调用方自行处理
            break;
          default:
            console.error('[onLoginFailed] unknown failAction:', failAction);
        }
      },
      
      authEngineMap: {}, //key: authType, value: BaseAuth
      defaultAuthType: '',
      userAuthHandler: null,
      
      loginStepAddOn: null,
    };

    Object.assign(this._configOptions, peerAssign({}, defaultOpts, configOptions));
    
    //初始化
    this._init();
    
    //标记状态
    this._stateInfo.isConfigReady = true;
  }

  /**
   * 追加配置项
   * 主要供子类调用，便于子类传递自定义配置项给自定义鉴权器/自定义钩子函数
   * 建议子类将所有自定义配置项封装成一个对象，总共占用一个key，避免未来和父类新增配置项命名冲突
   * @param {string} key 配置项名称
   * @param {object|*} value 配置项值
   * @protected
   */
  _appendConfig(key, value){
    if (key in this._configOptions) {
      console.error('[BaseLogin] _appendConfig, 新增配置项与已有配置项命名冲突：', key);
      return;
    }
    
    this._configOptions[key] = value;
  }

  /**
   * 初始化
   * @protected
   */
  _init(){
    //获取最近一次登录信息
    let lastLoginInfo = JSON.parse(wx.getStorageSync(this._configOptions.loginInfoStorage) || 'null');
    this._loginInfo = lastLoginInfo || this._loginInfo;
    
    //无最近登录信息时，设置默认值
    this._loginInfo.authType = this._loginInfo.authType || this._configOptions.defaultAuthType;
    
    //有指定前端登录态过期时间时，进行过期处理
    if (this._loginInfo.expireTime>0 &amp;&amp; Date.now()>this._loginInfo.expireTime)
      this.clearLogin();
  }
  
  /**
   * 登录
   *   | 登录模式 | common | silent | force | forceSilent | forceAuth |
   *   | --- | --- | --- | --- | --- | --- |
   *   | 定位 | 要有登录态 | 有登录态最好，没有就算了 | 要有严格登录态（保证前后端登录态一致且均未过期） | 有严格登录态最好，没有就算了 | 要展示登录界面 |
   *   | 是否复用已有登录信息 | √ | √ | × | × | × |
   *   | 是否尝试静默登录 | √ | √ | √ | √ | × |
   *   | 是否尝试授权登录 | √ | × | √ | × | √ |
   *   | 适用场景 | 适合大部分页面场景，如收藏、留言等 | 适合悄悄个性化，如首页个性化定制，搜索页个性化推荐等 | 适合重要且不能失败重试的场景，如重要的微信数据解密 | 适合不能失败重试但可以不要的场景，如不重要的微信数据解密 | 适合与登录界面强耦合的场景，如开发登录弹窗、演示登录界面 |
   * @param {Object} [options] 登录选项
   * @param {Function} [options.callback], 兼容起见支持回调，但更建议以Promise方式使用
   * @param {string} [options.mode] 登录模式，详见上文函数描述部分
   * @param {BaseLogin~UserAuthHandler} [options.userAuthHandler] 自定义用户授权交互
   * @param {String} [options.failAction] 失败处理方式：auto-自动处理 | none-调用方自行处理 | 其它-和onLoginFailed钩子函数约定的其它处理方式
   * @param {Object} [options.thisIssuer] 触发登录的组件的this对象，供钩子函数使用
   *
   * @return {BaseLogin~LoginRes} 登录结果
   */
  async login(options={}){
    //填充默认值
    const defaultOpts = {
      callback: null,
      mode: 'common',
      userAuthHandler: this._configOptions.userAuthHandler,
      failAction: 'auto',
      thisIssuer: null, //触发登录的组件的this对象，供钩子函数使用
    };

    options = Object.assign({}, defaultOpts, options);
    
    //状态记录
    let isNewlyLogin = !this.checkLogin(); //区分 未登录=>已登录 和 已登录=>刷新登录态
    
    //登录
    let loginRes = {};
    try {
      loginRes = await this._login(options);
    } catch (e){
      loginRes = {code: -500, errMsg:'internal error'};
      //真机下不支持打印错误栈，导致e打印出来是个空对象；故先单独打印一次e.message
      console.error('[login failed] uncaught error:',e &amp;&amp; e.message, e); 
    }
    
    //触发钩子
    if (loginRes.code!==0 &amp;&amp; loginRes.code!==-200) { //钩子：登录失败
      this._configOptions.onLoginFailed &amp;&amp; await this._configOptions.onLoginFailed.call(options.thisIssuer, loginRes, {failAction: options.failAction})
    }
    if (loginRes.code===0 &amp;&amp; isNewlyLogin) { //钩子：刚刚登录
      this._configOptions.onNewlyLogin &amp;&amp; await this._configOptions.onNewlyLogin.call(options.thisIssuer);
    }
    
    //返回结果
    options.callback &amp;&amp; options.callback(loginRes);
    return loginRes;
  }

  /**
   * @private
   */
  async _login(options){
    //初始状态：未开始
    let loginRes = {code: -1, errMsg: 'idle'};
    
    //尝试复用本地登录态
    let canUseLocal = !['force', 'forceSilent', 'forceAuth'].includes(options.mode); //是否可复用本地登录态
    loginRes = canUseLocal &amp;&amp; this.checkLogin() ? {code: 0, errMsg: 'ok'} :  loginRes; //本地登录状态
    if (loginRes.code === 0) //当前已登录且模式无特殊要求，按成功返回
      return {code: 0, errMsg: 'ok'};
    
    //尝试静默登录
    let canUseSilent = !['forceAuth'].includes(options.mode); //是否可尝试静默登录
    loginRes = canUseSilent ? await this._silentLogin(options) : loginRes;
    if (loginRes.code === 0) //静默登录成功，结束
      return {code: 0, errMsg: 'ok'};
    
    //尝试授权登录
    let canUseAuth = !['silent', 'forceSilent'].includes(options.mode); //是否可尝试授权登录
    loginRes = canUseAuth ?  await this._authLogin(options) : loginRes;
    if (loginRes.code === 0) //授权登录成功，结束
      return {code: 0, errMsg: 'ok'};

    //全部尝试失败，根据模式调整返回值
    if (['silent', 'forceSilent'].includes(options.mode)) //静默模式错误码调整为统一值（这些模式不想让用户感知到登录失败）
      loginRes.code = -200;
    
    //返回最终失败结果
    return loginRes;
  }

  /**
   * 静默登录
   * 在用户无感知的情况下悄悄完成登录过程
   * @param options 登录选项
   * @return {Promise&lt;*>}
   * @private
   */
  @mergingStep //步骤并合，避免页面中多处同时触发登录时重复发起登录请求
  async _silentLogin(options){
    //判断使用的验证方式
    let authType = this._loginInfo.authType;
    if (authType === 'none')
      return {code: -200, errMsg: 'login failed silently: disabled'};

    //获取验证方式对应的鉴权器
    let authEngine = this._configOptions.authEngineMap[authType];
    if (!authEngine) {
      console.error('[login] _silentLogin, cannot find authEngine for authType:', authType);
      return {code: -500, errMsg: 'login failed silently: internal error'};
    }
    
    //尝试静默登录
    let silentRes = {};
    try {
      silentRes = await authEngine.silentLogin({
        loginOptions: options,
        configOptions: this._configOptions,
      });
    } catch (e) {
      console.error('[login] caught error when try silentLogin of authType:', authType, 'err:', e);
      silentRes = {succeeded: false, errMsg: 'internal error'};
    }

    //更新匿名信息（登录成功前使用的临时标识，成功后继续关联）
    silentRes.anonymousInfo &amp;&amp; this._saveAnonymousInfo(silentRes.anonymousInfo);
    
    //登录失败，返回
    if (!silentRes.succeeded)
      return {code: -200, errMsg: 'login failed silently: normal'};
    
    //登录成功，保存相关信息
    return this._afterFetchInfoPack({
      isLogin: true,
      userInfo: silentRes.userInfo,
      expireTime: silentRes.expireTime,
      authType,
    });
  }

  /**
   * 授权登录
   * 需要用户配合才能完成的登录过程
   * @param options 登录选项
   * @return {Promise&lt;*>}
   * @private
   */
  @mergingStep //步骤并合，避免页面中多处同时触发登录时重复发起登录请求
  async _authLogin(options){
    //执行各鉴权器的beforeAuthLogin钩子
    let beforeResMap = {};
    for (let authType of Object.keys(this._configOptions.authEngineMap)) {
      let authEngine = this._configOptions.authEngineMap[authType];
      beforeResMap[authType] = authEngine.beforeAuthLogin ? await authEngine.beforeAuthLogin({
        loginOptions: options,
        configOptions: this._configOptions,
      }) : null;
    }
    
    //展示登录界面，等待用户交互
    let userAuthRes = await this._handleUserAuth(options);
    
    //交互失败（e.g.用户取消登录）
    if (!userAuthRes.succeeded) {
      this._configOptions.onUserAuthFailed &amp;&amp; this._configOptions.onUserAuthFailed.call(options.thisIssuer,{});
      return {code: -100, errMsg: 'user auth failed:' + userAuthRes.errMsg}
    }
    
    //交互成功
    
    //触发钩子：onUserAuthSucceeded
    this._configOptions.onUserAuthSucceeded &amp;&amp; this._configOptions.onUserAuthSucceeded.call(options.thisIssuer);
    
    //根据用户提供的信息进行登录
    let authType = userAuthRes.authType;
    let authEngine = this._configOptions.authEngineMap[authType];
    if (!authEngine) {
      console.error(`[login] 当前指定的登录方式：${authType}，不存在对应的鉴权器`);
      return {code: -500, errMsg: 'internal error'};
    }
    let authRes = await authEngine.authLogin({
      loginOptions: options,
      configOptions: this._configOptions,
      authData: userAuthRes.authData,
      beforeRes: beforeResMap[authType],
    });

    //更新匿名信息（登录成功前使用的临时标识，成功后继续关联）
    authRes.anonymousInfo &amp;&amp; this._saveAnonymousInfo(authRes.anonymousInfo);
    
    //登录失败，返回
    if (!authRes.succeeded)
      return {code: -300, errMsg: `auth login failed: ${authRes.errMsg}`, toastMsg: authRes.toastMsg};

    //登录成功，保存相关信息
    return this._afterFetchInfoPack({
      isLogin: true,
      userInfo: authRes.userInfo,
      expireTime: authRes.expireTime,
      authType,
    });
  }
  
  /**
   * 授权交互处理
   * @param options 登录选项，参见{@link BaseLogin#login}
   * @return {BaseLogin~UserAuthRes}
   * @protected
   */
  async _handleUserAuth(options){
    return await options.userAuthHandler.call(options.thisIssuer);
  }
  
  /**
   * 登录信息获取完毕后续步骤集合
   * @private
   * @param {BaseLogin~LoginInfo} loginInfo 登录信息
   */
  async _afterFetchInfoPack(loginInfo){
    this._saveInfo(loginInfo);

    let addOnRes = await this._handleAddOn();
    if (!addOnRes.succeeded) {
      this.clearLogin();
      return {code: -400, errMsg: addOnRes.errMsg||'add on failed', toastMsg: addOnRes.toastMsg};
    }
    
    return {code: 0, errMsg: 'ok'};
  }

  /**
   * 保存/更新登录信息
   * @param {BaseLogin~LoginInfo} loginInfo 登录信息
   * @protected
   */
  _saveInfo(loginInfo){
    Object.assign(this._loginInfo, loginInfo);

    wx.setStorage({
      key: this._configOptions.loginInfoStorage,
      data: JSON.stringify(this._loginInfo)
    });
  }

  /**
   * 保存/更新匿名信息
   * @param {object} anonymousInfo 匿名信息
   * @protected
   */
  _saveAnonymousInfo(anonymousInfo){
    Object.assign(this._loginInfo.anonymousInfo, anonymousInfo);
    
    wx.setStorage({
      key: this._configOptions.loginInfoStorage,
      data: JSON.stringify(this._loginInfo)
    });
  }
  
  /**
   * 支持使用方配置自定义附加步骤，会在正常登录流程执行成功时调用，并根据其处理结果生成最终登录结果
   * @return {BaseLogin~LoginStepAddOnRes}
   * @protected
   */
  async _handleAddOn(){
    if (!this._configOptions.loginStepAddOn)
      return {succeeded: true};

    let stepRes = await this._configOptions.loginStepAddOn();

    if (typeof stepRes !== "object"){
      console.error('[login] loginStepAddOn shall return an object, something like "{succeeded: true, errMsg:\'debug detail\', toastMsg: \'alert detail\'}", yet got return value:', stepRes);
      stepRes = {succeeded: false};
    }

    return stepRes;
  }
  
  /**
   *退出登录
   * @param {boolean} needClearAuth 是否需要清除鉴权信息：false-仅清除登录态，下次还可以静默登录 | true-同时清除鉴权信息，下次必须授权登录
   * @return {Object} res 退出登录结果，格式形如：{code:0, errMsg:'ok'}
   */
  logout({needClearAuth = false}={}){
    this.clearLogin({needClearAuth});
    return {code: 0, errMsg:'ok'};
  }

  /**
   * 重新登录
   * @return {BaseLogin~LoginRes} 登录结果
   */
  async reLogin(...args){
    await this.logout();
    return await this.login(...args);
  }

  /**
   * 清除前端登录态
   * @param {boolean} needClearAuth 是否需要清除鉴权信息：false-仅清除登录态，下次还可以静默登录 | true-同时清除鉴权信息，下次必须授权登录
   */
  clearLogin({needClearAuth=false}={}){
    this._loginInfo.isLogin = false;
    this._loginInfo.userInfo = {};
    this._loginInfo.expireTime = -1;
    this._loginInfo.authType = needClearAuth ? 'none' : this._loginInfo.authType;
    
    wx.setStorage({
      key: this._configOptions.loginInfoStorage,
      data: JSON.stringify(this._loginInfo)
    });
  }

  /**
   * 检查是否登录
   * @return {boolean}  是否登录
   */
  checkLogin(){
    return this._loginInfo.isLogin;
  }

  /**
   * 将方法封装为通用函数，使之可以在任意this对象上执行
   * @param {String} methodName 方法名
   * @return {Function} 封装后的函数
   */
  makeAssignableMethod(methodName){
    return makeAssignableMethod({
      instance: this,
      method: methodName,
      rcvThis: {
        argIdx: 0,
        argProp: 'thisIssuer'
      }
    });
  }
  
  /**
   * 获取用户信息
   * @return {Object} 用户信息
   */
  get userInfo(){
    return deepClone(this._loginInfo.userInfo);
  }
}

/**
 * 类修饰器，确保调用API时已完成模块配置
 * @ignore
 * @param target
 */
function requireConfig(target) {
  let descriptors = Object.getOwnPropertyDescriptors(target.prototype);
  for (let prop of Object.getOwnPropertyNames(descriptors)){
    let descriptor = descriptors[prop];
    if (typeof descriptor.value !== "function") //非函数，不予处理
      continue;
    if (['constructor', 'config'].includes(prop) || prop[0]==='_')  //无需配置的函数、私有函数，不予处理
      continue;

    descriptor.value = (function (oriFunc, funcName) {  //对外接口，增加配置检查步骤
      return function (...args) {
        if (!this._stateInfo.isConfigReady){ //若未进行项目信息配置，则报错
          console.error('[Login] 请先进行模块配置，后调用模块相关功能', '试图调用：', funcName);
          return;
        }
        return oriFunc.apply(this, args); //否则正常执行原函数
      }
    }(descriptor.value, prop));
    
    Object.defineProperty(target.prototype, prop, descriptor);
  }
}

/**
 * @typedef {Function} BaseLogin~OnLoginFailed 登录失败钩子函数
 * @param {BaseLogin~LoginRes} loginRes 登录结果
 * @param {object} options  选项
 * @param {string} options.failAction 调用方希望的失败处理方式：auto-自动处理 | none-调用方自行处理 | 其它约定值
 * @example
    onLoginFailed(res, {failAction}){
      switch (failAction) { //调用方希望的失败处理方式
        case 'auto': //自动处理
          wx.showToast({
            title: res.toastMsg || '登录失败',
            image: '/images/tipfail.png',
            duration: 3000
          });
          break;
        case 'none': //调用方自行处理
          break;
        default:
          console.error('[onLoginFailed] unknown failAction:', failAction);
      }
    }
 */
 /**
 * @typedef {object} BaseLogin~LoginRes 登录结果
 * @property {number} code 状态码
  * | code | 语义 |
  * | --- | --- |
  * | 0 | 成功 |
  * | -100 | 用户交互失败 e.g.用户拒绝授权等 |
  * | -200 | 静默失败，静默登录失败且调用方要求不要尝试授权登录 |
  * | -300 | 授权登录失败 |
  * | -400 | 附加步骤返回失败结果 |
  * | -500 | 模块内部异常 |
 * @property {string} errMsg 详细错误日志，debug用
 * @property {string} [toastMsg] （若有）用户话术，提示失败原因
 * @example
    {
      code: -300, //状态码，0为成功
      errMsg:'login api failed...', //详细错误日志，debug用
      toastMsg: '您的账号存在安全风险，请联系客服进行处理' //（若有）用户话术，提示失败原因
    }
 */

/**
 * @typedef {Function} BaseLogin~UserAuthHandler 授权交互处理函数，负责跟用户交互，收集鉴权所需信息
 * @async
 * @return {BaseLogin~UserAuthRes} 交互结果
 */

/**
 * @typedef {object} BaseLogin~UserAuthRes userAuthHandler交互结果
 * @property {boolean} succeeded 是否成功
 * @property {string} errMsg 错误信息，调试用
 * @property {string} authType 用户选择的登录方式
 * @property {object} authData 交互数据，格式由该登录方式对应的鉴权器指定
 */

/**
 * @typedef {Function} BaseLogin~LoginStepAddOn 登录流程自定义附加步骤
 * @async
 * @return {BaseLogin~LoginStepAddOnRes}
 */

/**
 * @typedef {object} BaseLogin~LoginStepAddOnRes 登录流程自定义附加步骤处理结果
 * @property {boolean} succeeded 是否成功
 * @property {string} [errMsg] 详细失败原因，debug用
 * @property {string} [toastMsg] （若有）用户话术，提示失败原因
 */

/**
 * @typedef {object} BaseLogin~LoginInfo 登录信息
 * @property {boolean} isLogin 是否登录
 * @property {object} userInfo 用户信息
 * @property {number} expireTime 过期时间，绝对毫秒数，-1表示长期有效
 * @property {string} authType 使用的验证方式
 * @property {object} [anonymousInfo] 匿名信息（登录成功前使用的临时标识，成功后继续关联）
 */

export default BaseLogin;</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Wed Nov 20 2019 13:58:30 GMT+0800 (中国标准时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>
