<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>Tutorial: [基础能力] 健壮高效的登录机制 - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav class="wrap">
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    <h2><a href="index.html">Home</a></h2><h2><a href="https://github.com/zhuanzhuanfe/fancy-mini" target="_blank" class="menu-item" id="website_link" >GitHub repo</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-0-getStarted.html">setup</a></li><li><a href="tutorial-1-demoProject.html">demo</a></li><li><a href="tutorial-2.1-login.html">[基础能力] 健壮高效的登录机制</a></li><li><a href="tutorial-2.2-navigate.html">[基础能力] 无限层级的路由机制</a></li><li><a href="tutorial-2.3-request.html">[基础能力] 灵活易扩展的请求管理</a></li><li><a href="tutorial-2.4-cookie.html">[基础能力] cookie机制</a></li><li><a href="tutorial-2.5-canvasKit.html">[基础能力] canvas工具集</a></li><li><a href="tutorial-2.6-wxPromise.html">[基础能力] 微信接口Promise化</a></li><li><a href="tutorial-2.7-routeParams.html">[基础能力] 跨页面传参</a></li><li><a href="tutorial-2.8-eventHub.html">[基础能力] 跨页面事件</a></li><li><a href="tutorial-2.9-customEntry.html">[基础能力] 入口构造工具</a></li><li><a href="tutorial-2.a-qrTest.html">[基础能力] 二维码测试工具</a></li><li><a href="tutorial-2.b-rewardedVideoPlayer.html">[基础能力] 激励视频播放器</a></li><li><a href="tutorial-3.1-adaptiveToast.html">[疑难杂症] toast截断问题</a></li><li><a href="tutorial-3.2-textArea.html">[疑难杂症] textarea遮盖浮层问题</a></li><li><a href="tutorial-4.1-dialogCommon.html">[组件库] 通用弹窗</a></li><li><a href="tutorial-4.2-operationGuide.html">[组件库] 新手引导</a></li><li><a href="tutorial-5.1-noConcurrent.html">[工具库] 免并发修饰器</a></li><li><a href="tutorial-5.2-errSafe.html">[工具库] 异常捕获修饰器</a></li><li><a href="tutorial-5.3-compatible.html">[工具库] 快捷兼容修饰器</a></li><li><a href="tutorial-5.3.1-typeCheck.html">[工具库] 类型检查修饰器</a></li><li><a href="tutorial-5.4-wepyKit.html">[工具库] wepy框架工具集</a></li><li><a href="tutorial-5.5-operationKit.html">[工具库] 基础操作工具集</a></li><li><a href="tutorial-5.6-handleStr.html">[工具库] GBK字符串处理工具集</a></li><li><a href="tutorial-5.7-countDowner.html">[工具库] 倒计时模块</a></li></ul><h3>Classes</h3><ul><li><a href="AdaptiveToast.html">AdaptiveToast</a><ul class='methods'><li data-type='method'><a href="AdaptiveToast.html#sysToastIcon">sysToastIcon</a></li><li data-type='method'><a href="AdaptiveToast.html#sysToastModal">sysToastModal</a></li><li data-type='method'><a href="AdaptiveToast.html#sysToastText">sysToastText</a></li><li data-type='method'><a href="AdaptiveToast.html#toast">toast</a></li></ul></li><li><a href="BaseAuth.html">BaseAuth</a><ul class='methods'><li data-type='method'><a href="BaseAuth.html#authLogin">authLogin</a></li><li data-type='method'><a href="BaseAuth.html#beforeAuthLogin">beforeAuthLogin</a></li><li data-type='method'><a href="BaseAuth.html#silentLogin">silentLogin</a></li></ul></li><li><a href="BaseLogin.html">BaseLogin</a><ul class='methods'><li data-type='method'><a href="BaseLogin.html#_appendConfig">_appendConfig</a></li><li data-type='method'><a href="BaseLogin.html#_handleAddOn">_handleAddOn</a></li><li data-type='method'><a href="BaseLogin.html#_handleUserAuth">_handleUserAuth</a></li><li data-type='method'><a href="BaseLogin.html#_init">_init</a></li><li data-type='method'><a href="BaseLogin.html#_mergeConfigOptions">_mergeConfigOptions</a></li><li data-type='method'><a href="BaseLogin.html#_saveAnonymousInfo">_saveAnonymousInfo</a></li><li data-type='method'><a href="BaseLogin.html#_saveInfo">_saveInfo</a></li><li data-type='method'><a href="BaseLogin.html#checkLogin">checkLogin</a></li><li data-type='method'><a href="BaseLogin.html#clearLogin">clearLogin</a></li><li data-type='method'><a href="BaseLogin.html#config">config</a></li><li data-type='method'><a href="BaseLogin.html#login">login</a></li><li data-type='method'><a href="BaseLogin.html#logout">logout</a></li><li data-type='method'><a href="BaseLogin.html#makeAssignableMethod">makeAssignableMethod</a></li><li data-type='method'><a href="BaseLogin.html#reLogin">reLogin</a></li></ul></li><li><a href="BasePlugin.html">BasePlugin</a><ul class='methods'><li data-type='method'><a href="BasePlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="BasePlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="BasePlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="BasePlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="BasePlugin.html#mount">mount</a></li></ul></li><li><a href="CloudFuncPlugin.html">CloudFuncPlugin</a><ul class='methods'><li data-type='method'><a href="CloudFuncPlugin.html#_execCloudFunc">_execCloudFunc</a></li><li data-type='method'><a href="CloudFuncPlugin.html#_parseReq">_parseReq</a></li><li data-type='method'><a href="CloudFuncPlugin.html#_parseRes">_parseRes</a></li><li data-type='method'><a href="CloudFuncPlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="CloudFuncPlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="CloudFuncPlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="CloudFuncPlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="CloudFuncPlugin.html#mount">mount</a></li></ul></li><li><a href="Cookie.html">Cookie</a><ul class='methods'><li data-type='method'><a href="Cookie.html#.cookieObjToStr">cookieObjToStr</a></li><li data-type='method'><a href="Cookie.html#.cookieStrToObj">cookieStrToObj</a></li><li data-type='method'><a href="Cookie.html#.mergeCookieStr">mergeCookieStr</a></li><li data-type='method'><a href="Cookie.html#get">get</a></li><li data-type='method'><a href="Cookie.html#getCookie">getCookie</a></li><li data-type='method'><a href="Cookie.html#set">set</a></li><li data-type='method'><a href="Cookie.html#setCookie">setCookie</a></li></ul></li><li><a href="CookiePlugin.html">CookiePlugin</a><ul class='methods'><li data-type='method'><a href="CookiePlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="CookiePlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="CookiePlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="CookiePlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="CookiePlugin.html#mount">mount</a></li></ul></li><li><a href="EventHub.html">EventHub</a><ul class='methods'><li data-type='method'><a href="EventHub.html#notify">notify</a></li><li data-type='method'><a href="EventHub.html#subscribe">subscribe</a></li><li data-type='method'><a href="EventHub.html#unsubscribe">unsubscribe</a></li></ul></li><li><a href="FailRecoverPlugin.html">FailRecoverPlugin</a><ul class='methods'><li data-type='method'><a href="FailRecoverPlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="FailRecoverPlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="FailRecoverPlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="FailRecoverPlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="FailRecoverPlugin.html#mount">mount</a></li></ul></li><li><a href="FormPlugin.html">FormPlugin</a><ul class='methods'><li data-type='method'><a href="FormPlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="FormPlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="FormPlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="FormPlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="FormPlugin.html#mount">mount</a></li></ul></li><li><a href="History.html">History</a><ul class='methods'><li data-type='method'><a href="History.html#back">back</a></li><li data-type='method'><a href="History.html#config">config</a></li><li data-type='method'><a href="History.html#doCorrection">doCorrection</a></li><li data-type='method'><a href="History.html#getRoute">getRoute</a></li><li data-type='method'><a href="History.html#open">open</a></li><li data-type='method'><a href="History.html#replace">replace</a></li><li data-type='method'><a href="History.html#savePage">savePage</a></li></ul></li><li><a href="InstantPlugin.html">InstantPlugin</a><ul class='methods'><li data-type='method'><a href="InstantPlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="InstantPlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="InstantPlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="InstantPlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="InstantPlugin.html#mount">mount</a></li></ul></li><li><a href="LoginPlugin.html">LoginPlugin</a><ul class='methods'><li data-type='method'><a href="LoginPlugin.html#afterRequest">afterRequest</a></li><li data-type='method'><a href="LoginPlugin.html#afterRequestAsync">afterRequestAsync</a></li><li data-type='method'><a href="LoginPlugin.html#beforeRequest">beforeRequest</a></li><li data-type='method'><a href="LoginPlugin.html#beforeRequestAsync">beforeRequestAsync</a></li><li data-type='method'><a href="LoginPlugin.html#mount">mount</a></li><li data-type='method'><a href="LoginPlugin.html#requestWithLogin">requestWithLogin</a></li></ul></li><li><a href="Navigator.html">Navigator</a><ul class='members'><li data-type='member'><a href="Navigator.html#.history">history</a></li></ul><ul class='methods'><li data-type='method'><a href="Navigator.html#.config">config</a></li><li data-type='method'><a href="Navigator.html#.navigateBack">navigateBack</a></li><li data-type='method'><a href="Navigator.html#.navigateTo">navigateTo</a></li><li data-type='method'><a href="Navigator.html#.onPageUnload">onPageUnload</a></li><li data-type='method'><a href="Navigator.html#.redirectTo">redirectTo</a></li><li data-type='method'><a href="Navigator.html#.reLaunch">reLaunch</a></li><li data-type='method'><a href="Navigator.html#.switchTab">switchTab</a></li></ul></li><li><a href="Requester.html">Requester</a><ul class='methods'><li data-type='method'><a href="Requester.html#config">config</a></li><li data-type='method'><a href="Requester.html#makeAssignableMethod">makeAssignableMethod</a></li><li data-type='method'><a href="Requester.html#registerToThis">registerToThis</a></li><li data-type='method'><a href="Requester.html#request">request</a></li></ul></li><li><a href="RewardedVideoPlayer.html">RewardedVideoPlayer</a><ul class='methods'><li data-type='method'><a href="RewardedVideoPlayer.html#handlePageChange">handlePageChange</a></li><li data-type='method'><a href="RewardedVideoPlayer.html#load">load</a></li><li data-type='method'><a href="RewardedVideoPlayer.html#onLoadStateChange">onLoadStateChange</a></li><li data-type='method'><a href="RewardedVideoPlayer.html#play">play</a></li></ul></li><li><a href="RouteParams.html">RouteParams</a><ul class='methods'><li data-type='method'><a href="RouteParams.html#clearBackFrom">clearBackFrom</a></li><li data-type='method'><a href="RouteParams.html#clearOpenFrom">clearOpenFrom</a></li><li data-type='method'><a href="RouteParams.html#getBackFromData">getBackFromData</a></li><li data-type='method'><a href="RouteParams.html#getBackFromRoute">getBackFromRoute</a></li><li data-type='method'><a href="RouteParams.html#getOpenFromData">getOpenFromData</a></li><li data-type='method'><a href="RouteParams.html#getOpenFromRoute">getOpenFromRoute</a></li><li data-type='method'><a href="RouteParams.html#setBackFromData">setBackFromData</a></li><li data-type='method'><a href="RouteParams.html#setOpenFromData">setOpenFromData</a></li></ul></li><li><a href="WechatAuth.html">WechatAuth</a><ul class='methods'><li data-type='method'><a href="WechatAuth.html#authLogin">authLogin</a></li><li data-type='method'><a href="WechatAuth.html#beforeAuthLogin">beforeAuthLogin</a></li><li data-type='method'><a href="WechatAuth.html#loginByWxAuth">loginByWxAuth</a></li><li data-type='method'><a href="WechatAuth.html#loginByWxSilent">loginByWxSilent</a></li><li data-type='method'><a href="WechatAuth.html#silentLogin">silentLogin</a></li><li data-type='method'><a href="WechatAuth.html#wxLogin">wxLogin</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-canvasKit.html">canvasKit</a><ul class='methods'><li data-type='method'><a href="module-canvasKit.html#.aspectFill">aspectFill</a></li><li data-type='method'><a href="module-canvasKit.html#.aspectFit">aspectFit</a></li><li data-type='method'><a href="module-canvasKit.html#.borderRadius">borderRadius</a></li><li data-type='method'><a href="module-canvasKit.html#.createBorderRadiusPath">createBorderRadiusPath</a></li><li data-type='method'><a href="module-canvasKit.html#.ellipsisStr">ellipsisStr</a></li><li data-type='method'><a href="module-canvasKit.html#.fillText">fillText</a></li><li data-type='method'><a href="module-canvasKit.html#.rounded">rounded</a></li><li data-type='method'><a href="module-canvasKit.html#.strLenGraphic">strLenGraphic</a></li></ul></li><li><a href="module-compatible.html">compatible</a><ul class='methods'><li data-type='method'><a href="module-compatible.html#.supportWXCallback">supportWXCallback</a></li></ul></li><li><a href="module-countDowner.html">countDowner</a><ul class='methods'><li data-type='method'><a href="module-countDowner.html#off">off</a></li><li data-type='method'><a href="module-countDowner.html#on">on</a></li><li data-type='method'><a href="module-countDowner.html#pause">pause</a></li><li data-type='method'><a href="module-countDowner.html#restart">restart</a></li></ul></li><li><a href="module-decorators.html">decorators</a></li><li><a href="module-errSafe.html">errSafe</a><ul class='methods'><li data-type='method'><a href="module-errSafe.html#.errSafe">errSafe</a></li><li data-type='method'><a href="module-errSafe.html#.withErrToast">withErrToast</a></li></ul></li><li><a href="module-globalEvents.html">globalEvents</a></li><li><a href="module-handleStr.html">handleStr</a><ul class='methods'><li data-type='method'><a href="module-handleStr.html#.cutstr">cutstr</a></li><li data-type='method'><a href="module-handleStr.html#.strLength">strLength</a></li></ul></li><li><a href="module-noConcurrent.html">noConcurrent</a><ul class='methods'><li data-type='method'><a href="module-noConcurrent.html#.makeMutex">makeMutex</a></li><li data-type='method'><a href="module-noConcurrent.html#.makeNoConcurrent">makeNoConcurrent</a></li><li data-type='method'><a href="module-noConcurrent.html#.mergingStep">mergingStep</a></li><li data-type='method'><a href="module-noConcurrent.html#.noConcurrent">noConcurrent</a></li><li data-type='method'><a href="module-noConcurrent.html#.singleAisle">singleAisle</a></li></ul></li><li><a href="module-operationKit.html">operationKit</a><ul class='methods'><li data-type='method'><a href="module-operationKit.html#.appendUrlParam">appendUrlParam</a></li><li data-type='method'><a href="module-operationKit.html#.combineFuncs">combineFuncs</a></li><li data-type='method'><a href="module-operationKit.html#.compareVersion">compareVersion</a></li><li data-type='method'><a href="module-operationKit.html#.deepAssign">deepAssign</a></li><li data-type='method'><a href="module-operationKit.html#.deepClone">deepClone</a></li><li data-type='method'><a href="module-operationKit.html#.deepEqual">deepEqual</a></li><li data-type='method'><a href="module-operationKit.html#.delay">delay</a></li><li data-type='method'><a href="module-operationKit.html#.isNonEmptyObject">isNonEmptyObject</a></li><li data-type='method'><a href="module-operationKit.html#.isNonNullObject">isNonNullObject</a></li><li data-type='method'><a href="module-operationKit.html#.makeAssignableMethod">makeAssignableMethod</a></li><li data-type='method'><a href="module-operationKit.html#.padStart">padStart</a></li><li data-type='method'><a href="module-operationKit.html#.parseInlineStyle">parseInlineStyle</a></li><li data-type='method'><a href="module-operationKit.html#.peerAssign">peerAssign</a></li><li data-type='method'><a href="module-operationKit.html#.queryRect">queryRect</a></li><li data-type='method'><a href="module-operationKit.html#.semanticRemainTime">semanticRemainTime</a></li><li data-type='method'><a href="module-operationKit.html#.toAbsolutePath">toAbsolutePath</a></li><li data-type='method'><a href="module-operationKit.html#.toInlineStyle">toInlineStyle</a></li></ul></li><li><a href="module-typeCheck.html">typeCheck</a><ul class='methods'><li data-type='method'><a href="module-typeCheck.html#.typeCheck">typeCheck</a></li></ul></li><li><a href="module-uniAppKit.html">uniAppKit</a><ul class='methods'><li data-type='method'><a href="module-uniAppKit.html#.getCurUniPage">getCurUniPage</a></li><li data-type='method'><a href="module-uniAppKit.html#.pageRestoreHandler">pageRestoreHandler</a></li><li data-type='method'><a href="module-uniAppKit.html#.registerPageHook">registerPageHook</a></li><li data-type='method'><a href="module-uniAppKit.html#.registerToThis">registerToThis</a></li></ul></li><li><a href="module-wepyKit.html">wepyKit</a><ul class='members'><li data-type='member'><a href="module-wepyKit.html#.NavRefine">NavRefine</a></li></ul><ul class='methods'><li data-type='method'><a href="module-wepyKit.html#.getCurWepyPage">getCurWepyPage</a></li><li data-type='method'><a href="module-wepyKit.html#.pageRestoreHandler">pageRestoreHandler</a></li><li data-type='method'><a href="module-wepyKit.html#.registerPageHook">registerPageHook</a></li><li data-type='method'><a href="module-wepyKit.html#.registerToThis">registerToThis</a></li></ul></li><li><a href="module-wxPromise.html">wxPromise</a><ul class='members'><li data-type='member'><a href="module-wxPromise.html#.wxPromise">wxPromise</a></li><li data-type='member'><a href="module-wxPromise.html#.wxResolve">wxResolve</a></li></ul><ul class='methods'><li data-type='method'><a href="module-wxPromise.html#.customWxPromisify">customWxPromisify</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">Tutorial: [基础能力] 健壮高效的登录机制</h1>
    

    <section>

<header>
    

    <h2>[基础能力] 健壮高效的登录机制</h2>
</header>

<article>
    <h3>效果</h3>
<ul>
<li>用户体验
<ul>
<li>流畅<br>
登录过程不会阻塞操作，登录前后自然衔接，e.g.点击留言-触发登录-自动继续完成留言行为，不需要刷新页面也不需要再次点击留言按钮。</li>
<li>多元<br>
支持不同小程序不同页面不同场景配置不同的登录界面和登录流程，在合适的时候通过合适的引导提高用户登录意愿。</li>
<li>精细<br>
支持一进页面就悄悄对用户进行精细区分，对老用户进行个性化定制，同时不需要弹出登录界面打扰新用户；支持精细控制登录时机，可以在新用户进行任何一项要求登录的操作时自动触发登录流程。</li>
</ul>
</li>
<li>业务开发
<ul>
<li>省心<br>
只需指明业务功能是否需要登录态即可，各种登录细节不用管，e.g.留言业务，只需指明“留言过程需要登录态”即可，至于：用户点击留言按钮时登录了没、怎么进行登录交互、会不会页面其它地方正登录到一半、会不会后端登录态刚好过期了等各种问题都不需要业务方care。</li>
<li>自由<br>
不想关注登录时，各种细节完全不用care；想关注时，各种细节又都可以自由定制，e.g.定制登录界面、跳过登录界面、附加登录步骤、监听登录成功等。</li>
</ul>
</li>
<li>健壮性
<ul>
<li>后端登录态过期自动重新登录，避免前后端登录态时效差异造成偶现功能异常</li>
<li>页面多处同时触发登录自动合并，避免时序混乱互相干扰造成潜在逻辑异常</li>
<li>各机制对调用方透明，不依赖调用方自觉性，避免调用失误造成业务异常</li>
</ul>
</li>
<li>高效性
<ul>
<li>后端登录态惰性检查，节约每次校验开销</li>
<li>公共步骤免并发，节约并发成本</li>
<li>前后操作无缝衔接，节约用户重复操作开销</li>
</ul>
</li>
<li>复用、扩展、维护
<ul>
<li>支持多小程序多页面多场景复用</li>
<li>公共流程统一维护，差异特性各自扩展</li>
<li>支持子类继承自定义逻辑扩展</li>
</ul>
</li>
</ul>
<h3>原理</h3>
<p>详见ppt：<a href="./static/ppt/fancy-mini_login.pptx">健壮高效的小程序登录方案</a></p>
<h3>基础用法</h3>
<ol start="0">
<li><a href="./tutorial-0-getStarted.html">fancy-mini setup</a></li>
<li>编写鉴权逻辑<br>
编写鉴权模块，根据用户提供的信息，完成校验过程，并返回对应的登录数据。e.g.:</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //FancyWechatAuth.js
  import WechatAuth from &quot;fancy-mini/lib/login/auth/WechatAuth&quot;;

  /**
   * 微信登录鉴权模块-自定义实现示例
   */
  class FancyWechatAuth extends WechatAuth {
    /**
     * 微信授权登录
     * 根据用户同意授权后从微信处拿到的信息，完成登录过程
     * @param {WechatAuth~WxLoginRes} wxLoginRes wx.login执行结果
     * @param {Object} authData 登录界面交互结果，格式同wx.getUserInfo返回结果
     * @param loginOptions 登录函数调用参数，参见<a href="BaseLogin.html#login">BaseLogin#login</a>
     * @param configOptions 登录模块配置参数，参见<a href="BaseLogin.html#config">BaseLogin#config</a>
     * @return {BaseAuth~LoginRes}
     */
    async loginByWxAuth({wxLoginRes, authData, loginOptions, configOptions}) {
      //调用后端接口，根据微信授权信息获取登录结果
      let loginRes = await configOptions.requester.request({
        url: 'https://xxx/wxAuthLogin', //todo：换成实际后端接口
        data: {
          code: wxLoginRes.code,
          encryptedData: authData.encryptedData,
          iv: authData.iv,
          //...
        },
        method: &quot;POST&quot;,
      });

      //后端：
      //  1. 调用微信api，根据入参中的code，获取session_key，官方文档：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html
      //  2. 调用微信api，根据入参中的encryptedData、iv和上一步中获取的session_key，获取微信用户标识和用户信息，官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/signature.html
      //      2.1 用户标识：openId，用户在小程序中的唯一标识，因小程序而异
      //      2.2 用户标识：unionId，用户在同一主体中的唯一标识，同一用户在同一主体下的所有小程序、公众号、网页、APP等应用中unionId一致
      //      2.3 用户信息：昵称、头像、性别、地区等
      //  3. 根据上一步中获取的openId/unionId，查询用户表；若存在相关记录，则返回对应用户信息，登录成功；若不存在，则自动注册，并存储微信用户信息作为用户初始信息，存储微信用户标识作为关联标识备查，之后返回对应用户信息，登录成功。

      //登录失败处理 todo: 根据接口实际格式进行字段调整
      if (loginRes.respCode != 0) {
        return {
          succeeded: false, //是否成功
          errMsg: 'login api failed:' + JSON.stringify(loginRes), //详细错误信息，调试用
          toastMsg: loginRes.respData && loginRes.respData.errMsg //（若有）错误话术，向用户提示用
        };
      }

      //登录成功处理 todo: 根据接口实际格式进行字段调整
      let data = loginRes.respData;
      return {
        succeeded: true, //是否成功
        errMsg: 'ok', //错误信息
        userInfo: { //用户信息 todo: 改为实际所需格式
          nickName: data.nickName, //昵称
          avatarUrl: data.avatarUrl, //头像
          gender: data.gender, //性别
          uid: data.uid, //后端自己维护的用户标识
          sessionKey: data.sessionKey, //后端自己维护的登录凭证
        },
        expireTime: Date.now() + data.validityPeriod, //有效期至，格式：绝对时间戳，-1表示长期有效
        anonymousInfo: { //（若有）匿名信息，登录前分配的临时标识，登录后继续关联
          token: data.token,
        },
      };
    }

    /**
     * 微信静默登录
     * 在用户无感知的情况下悄悄完成登录过程
     * @param {WechatAuth~WxLoginRes} wxLoginRes wx.login执行结果
     * @param loginOptions 登录函数调用参数，参见<a href="BaseLogin.html#login">BaseLogin#login</a>
     * @param configOptions 登录模块配置参数，参见<a href="BaseLogin.html#config">BaseLogin#config</a>
     * @return {BaseAuth~LoginRes}
     */
    async loginByWxSilent({wxLoginRes, loginOptions, configOptions}) {
      let loginRes = await configOptions.requester.request({
        url: 'https://xxx/wxSilentLogin', //todo:换成实际后端接口
        data: {
          code: wxLoginRes.code,
          //...
        },
        method: &quot;POST&quot;,
      });

      //后端：
      //  1. 调用微信api，根据入参中的code，获取openId，官方文档：https://developers.weixin.qq.com/miniprogram/dev/api-backend/open-api/login/auth.code2Session.html
      //  2. 根据openId，查询用户表；若存在相关记录，则返回对应用户信息，登录成功；若不存在相关记录，则登录失败
      //     效果：老用户可以在无感知的情况下悄悄静默登录；新用户依然是要等到授权登录时拿到用户信息才进行注册和登录，但静默尝试用户无感知，不会产生打扰

      //登录失败处理 todo:根据接口实际格式进行字段调整
      if (loginRes.respCode != 0) {
        return {
          succeeded: false, //是否成功
          errMsg: 'fail', //详细错误信息，调试用
          anonymousInfo: { //（若有）匿名信息，登录前分配的临时标识，登录后继续关联
            token: loginRes.respData.token,
          }
        };
      }

      //登录成功处理 todo:根据接口实际格式进行字段调整
      let data = loginRes.respData;

      return {
        succeeded: true, //是否成功
        errMsg: 'ok', //错误信息
        userInfo: { //用户信息 todo: 改为实际所需格式
          nickName: data.nickName, //昵称
          avatarUrl: data.avatarUrl, //头像
          gender: data.gender, //性别
          uid: data.uid, //后端自己维护的用户标识
          sessionKey: data.sessionKey, //后端自己维护的登录凭证
        },
        expireTime: Date.now() + data.validityPeriod, //有效期至，格式：绝对时间戳，-1表示长期有效
        anonymousInfo: { //（若有）匿名信息，登录前分配的临时标识，登录后继续关联
          token: data.token,
        },
      }
    }
  }

  export default FancyWechatAuth;
</code></pre>
<p><a id="extendLogin"></a></p>
<ol start="2">
<li>编写登录逻辑<br>
编写登录模块，添加自定义参数、自定义流程等。e.g.：</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //FancyLogin.js
  import BaseLogin from 'fancy-mini/lib/login/BaseLogin';
  import {peerAssign} from 'fancy-mini/lib/operationKit';

  /**
   * 登录模块-自定义实现示例
   * 通过继承覆盖的形式，可以在登录模块的各个环节中添加各种自定义逻辑
   * e.g.引入cookie逻辑，使得所有接口请求自动携带登录信息
   */
  class FancyLogin extends BaseLogin{
    cookie = null;

    //模块配置
    config(configOptions){
      //参数校验...

      //处理模块自身所需的自定义参数
      this.cookie = configOptions.cookie;

      //处理需要传递给鉴权模块、钩子函数等其它可配模块的自定义参数
      const defaultFancyOpts = {
        source: '', //小程序编号，用于区分不同的小程序，由rd指定，后端可以根据source查询到对应小程序的appId、appSecret等信息
      };

      let fancyOptions = peerAssign({}, defaultFancyOpts, configOptions);

      //注册额外参数
      this._appendConfig('fancyOptions', fancyOptions); //则鉴权模块、钩子函数等可以通过 configOptions.fancyOptions 拿到这些自定义参数

      //处理通用参数
      super.config(configOptions);
    }

    //模块初始化
    _init(){
      super._init();

      //写入cookie
      this.cookie.set('uid', this._loginInfo.userInfo.uid || '');
      this.cookie.set('sessionKey', this._loginInfo.userInfo.sessionKey || '');
    }

    //清除登录态
    clearLogin(...args){
      super.clearLogin(...args);
      cookie.set('uid', '');
      cookie.set('sessionKey', '');
    }

    //保存/更新用户信息
    _saveInfo(loginInfo){
      super._saveInfo(loginInfo);

      // 写入cookie
      cookie.set('uid', loginInfo.userInfo.uid);
      cookie.set('sessionKey', loginInfo.userInfo.sessionKey);
    }
  }

  export default FancyLogin;

</code></pre>
<p><a id="appConfig"></a></p>
<ol start="3">
<li>进行整体配置<br>
小程序引入登录模块，提供相关信息并进行整体配置。e.g.：</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //appPlugin.js
  import FancyLogin from &quot;../demoExtend/login/FancyLogin&quot;;
  import FancyWechatAuth from &quot;../demoExtend/login/auth/FancyWechatAuth&quot;;
  import LoginPlugin from &quot;fancy-mini/lib/request/plugin/LoginPlugin&quot;;
  import Requester from &quot;fancy-mini/lib/request/Requester&quot;;
  import Cookie from 'fancy-mini/lib/Cookie';
  import CookiePlugin from 'fancy-mini/lib/request/plugin/CookiePlugin';
  import {authEvents} from 'fancy-mini/lib/globalEvents';

  //实例创建
  const loginCenter = new FancyLogin(); //登录中心
  const requester = new Requester(); //请求管理器
  const cookie = new Cookie(); //cookie管理器

  //登录模块配置
  loginCenter.config({
    requester, //请求管理器，用于发送接口请求
    authEngineMap: { //鉴权器映射表，key为登录方式，value为对应的鉴权器
      'wechat' : new FancyWechatAuth(), //登录方式：微信，鉴权器：微信登录鉴权
    },
    defaultAuthType: 'wechat', //默认登录方式：微信
    async userAuthHandler(){ //默认登录交互
      let userAuthRes = await new Promise(resolve=>{
        authEvents.subscribe({ //监听交互结果
          eventType: 'userAuthFinish',
          handler: resolve, //交互结束时resolve当前promise
          persistType: 'once'
        });
        wx.navigateTo({ //展示登录界面
          url: '/pages/login/index'
        });
      });

      //等待用户交互，直到用户交互结束，登录界面信息收集完毕，该Promise才会被resolve，后续代码才会自动继续执行

      //返回交互结果
      return userAuthRes;
    },

    //自定义参数
    cookie,
    source: 1,
  });

  //请求管理器配置
  requester.config({
    plugins: [
      //登录插件，在请求前后自动加入登录态相关逻辑
      new LoginPlugin({
        loginCenter,
        apiAuthFailChecker(resData, reqOptions){ //根据接口返回内容，判断后端登录态是否已失效
          return (
            (resData.respMsg && resData.respMsg.includes('请登录')) || //后端登录态失效通用判断条件
            (reqOptions.url.includes('/bizA/') && resData.respCode===-1) || //业务线A后端接口登录态失效
            (reqOptions.url.includes('/bizB/') && resData.respCode===-2) //业务线B后端接口登录态失效
          );
        }
      }),
      //cookie插件，在请求前后自动加入cookie相关逻辑
      new CookiePlugin({
        cookie,
      }),
    ]
  });

  export {
    requester,
    loginCenter,
    cookie,
  }

</code></pre>
<ol start="4">
<li>编写登录界面<br>
小程序提供一个默认的登录界面，负责完成登录交互收集所需信息。e.g.：（示例采用wepy1.x框架语法，其它框架类似）</li>
</ol>
<pre class="prettyprint source lang-html"><code>  &lt;template>
    &lt;view>
      &lt;button open-type=&quot;getUserInfo&quot; @getuserinfo=&quot;onGetUserInfo&quot;>立即登录&lt;/button>
    &lt;/view>
  &lt;/template>

  &lt;script>
    //pages/login/index.wpy
    import wepy from 'wepy';
    import {authEvents} from 'fancy-mini/lib/globalEvents';

    export default class extends wepy.page {
      config = {
        navigationBarTitleText: '登录',
      }

      data = {
        isActiveUnload: false, //是否代码主动触发的页面卸载：true-代码主动退出 | false-被动退出（e.g.用户点击了系统返回按钮）
      }

      methods = {
        onGetUserInfo(ev){
          //授权失败，留在当前界面，等待用户再次交互
          if (!ev.detail.errMsg.includes('ok'))
            return;

          //授权成功

          //通知登录模块交互结果
          authEvents.notify({
            eventType: 'userAuthFinish',
            data: {
              succeeded: true, //是否成功收集到了所需信息
              errMsg: 'ok', //（失败时）错误信息
              authType: 'wechat', //（成功时）用户选择的登录方式
              authData: { //（成功时）该登录方式所需的鉴权信息
                ...ev.detail
              }
            }
          });

          //自动返回
          this.isActiveUnload = true;
          wx.navigateBack();
        }
      }

      onUnload() {
        //被动退出页面时，通知登录模块交互结果
        if (!this.isActiveUnload) {
          authEvents.notify({
            eventType: 'userAuthFinish',
            data: {
              succeeded: false, //是否成功收集到了所需信息
              errMsg: 'cancel', //（失败时）错误信息
              authType: '', //（成功时）用户选择的登录方式
              authData: { //（成功时）该登录方式所需的鉴权信息
              }
            }
          });
        }
      }
    }
  &lt;/script>
</code></pre>
<ol start="5">
<li>手动触发登录<br>
页面/组件中调用登录相关api，手动触发登录相关功能。e.g.：</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //页面/组件
  import {loginCenter} from '../../lib/appPlugin';

  async onLoad(){
    let loginRes = await loginCenter.login(); //登录
    console.log('login finished, res:', loginRes);
  }
</code></pre>
<ol start="6">
<li>自动触发登录<br>
页面/组件中调用接口相关api，自动触发登录功能。e.g.：</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //页面/组件
  import {requester} from '../../lib/appPlugin';

  //留言
  async onComment(){
    let commentRes = await requester.requestWithLogin({ //调用留言接口时使用requestWithLogin表明“该接口需要登录态”
      url: 'https://xxx/comment',
      data: {
        //...
      }
    });
    
    //则模块会在请求前后自动加入登录态相关逻辑：
    //  1.请求发出前，若未登录，则先触发登录，成功后再发送接口请求，失败则取消接口调用
    //  2.请求返回后，若判断后端登录态已失效，则自动重新登录重新发送接口请求，并以重新请求的结果作为本次调用结果返回
    
    //业务方无需关注是否已登录、如何登录、登录并发、登录态过期等各种问题，直接正常进行业务逻辑后续处理即可
    console.log('comment finished, res:', commentRes); //处理留言接口返回的内容
  }
</code></pre>
<h3>注册到this上使用</h3>
<p>可以将相关方法注册到组件/页面的this对象上，便于组件/页面直接使用。</p>
<ol>
<li>将相关功能注册到this上</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //appPlugin.js
  import {registerToThis} from 'fancy-mini/lib/wepyKit';
  
  //接上例，登录相关模块引入&配置...
  
  //将登录模块相关功能注册到this上，方便组件/页面直接使用
  const propMapThis2Login = { //命名映射，key为this属性名，value为loginCenter属性名, '*this'表示loginCenter自身
    '$loginCenter': '*this', // this.$loginCenter 对应 loginCenter
    '$login': 'login', // this.$login() 对应 loginCenter.login()
    '$logout': 'logout',
    '$reLogin': 'reLogin',
    '$checkLogin': 'checkLogin',
  };

  for (let [thisProp, loginProp] of Object.entries(propMapThis2Login)) {
    let loginTarget = loginProp === '*this' ? loginCenter : loginCenter.makeAssignableMethod(loginProp);
    registerToThis(thisProp, loginTarget);
  }

  //将请求模块相关功能注册到this上，方便组件/页面直接使用
  const propMapThis2Requester = { //命名映射，key为this属性名，value为requester属性名, '*this'表示requester自身
    '$requester': '*this', // this.$requester 对应 requester
    '$http': 'request', // this.$http() 对应 requester.request()
    '$httpWithLogin':'requestWithLogin', //this.$httpWithLogin() 对应 requester.requestWithLogin()
  };

  for (let [thisProp, requesterProp] of Object.entries(propMapThis2Requester)) {
    let requesterTarget = requesterProp === '*this' ? requester : requester.makeAssignableMethod(requesterProp);
    registerToThis(thisProp, requesterTarget);
  }
  
  //...
</code></pre>
<ol start="2">
<li>使注册生效</li>
</ol>
<pre class="prettyprint source lang-js"><code>//项目入口文件（app.js/app.wpy/app.vue/main.js/……，因框架而异）
import './lib/appPlugin';  //负责各种小程序级公共模块的引入和配置
</code></pre>
<ol start="3">
<li>页面/组件直接使用相关功能</li>
</ol>
<pre class="prettyprint source lang-js"><code>  import wepy from 'wepy';

  export default class extends wepy.page {
    async onLoad(){
      let loginRes = await this.$login(); //可以直接通过this调用相关方法，而不用每次引入相关模块
      console.log('login finished, res:', loginRes);
      
      let commentRes = await this.$httpWithLogin({ //可以直接通过this调用相关方法，而不用每次引入相关模块
        url: 'https://xxx/comment',
        data: {
          //...
        }
      });
      console.log('comment finished, res:', commentRes); 
    }
  }
</code></pre>
<h3>模块级功能定制</h3>
<p>对登录模块有特殊需求时，支持进行各种自定义逻辑扩展。<br>
如上文中<a href="#extendLogin">编写登录逻辑</a>小节所示，可以通过继承&amp;重写的方式编写自己的登录模块，从而实现各种模块级功能定制。<br>
可重写节点详见：<a href="./BaseLogin.html">API文档-登录模块</a>、<a href="https://github.com/zhuanzhuanfe/fancy-mini/blob/master/src/login/BaseLogin.js">源码-登录模块</a>。</p>
<h3>小程序级功能定制</h3>
<p>同时维护多个小程序时，支持所有小程序共用一个登录模块的同时，各自指定不同的功能逻辑。<br>
如上文中<a href="#appConfig">进行整体配置</a>小节所示，小程序可以通过传入各种配置项改写登录模块的默认行为，从而实现各种小程序级功能定制。<br>
可配项详见：<a href="BaseLogin.html#config">BaseLogin#config</a></p>
<h3>页面级功能定制</h3>
<p>同一小程序中，支持不同页面指定不同的登录逻辑。</p>
<ol>
<li>小程序中配置页面级参数获取方式</li>
</ol>
<pre class="prettyprint source lang-js"><code>  //appPlugin.js
  import {getCurWepyPage} from 'fancy-mini/lib/wepyKit';
  
  //...
  
  //登录模块配置
  loginCenter.config({
    //...
    pageConfigHandler(){ //获取页面级登录配置
      let curPage = getCurWepyPage() || {}; //获取当前页面实例
      return curPage.$loginOpts; //返回当前页面的自定义配置参数
    },
  });
  
  //...
</code></pre>
<ol start="2">
<li>页面中进行功能定制</li>
</ol>
<pre class="prettyprint source lang-js"><code>  import wepy from 'wepy';

  export default class extends wepy.page {
    //对登录行为进行页面级定制
    $loginOpts = {
      userAuthHandler: async()=>{ //默认登录界面
        //展示更符合本页面风格和本页面价值点的登录弹窗，而不使用小程序默认登录交互，提高用户登录意愿
        //...
      },
      onNewlyLogin: ()=>{ //钩子函数，未登录=>已登录 时触发
        //当页面中任何位置成功发生登录行为时
        //更新页面中所有的用户相关数据...
      }
    }
  }
</code></pre>
<p>可配项详见：<a href="BaseLogin.html#_mergeConfigOptions">BaseLogin#_mergeConfigOptions</a></p>
<h3>调用级功能定制</h3>
<p>同一页面中，支持不同函数指定不同的登录逻辑。</p>
<pre class="prettyprint source lang-js"><code>  let loginRes = await this.$login({
    userAuthHandler: async()=>{ //指定登录界面
      //展示更符合本次操作价值点的登录弹窗，而不使用小程序级/页面级默认登录交互，提高用户登录意愿
      //...
    },
  });
  
  let commentRes = await this.$httpWithLogin({
    url: 'https://xxx/comment',
    data: {
      //...
    },
    loginOpts: { 
      userAuthHandler: async()=>{ //指定登录界面
        //展示更符合本次操作价值点的登录弹窗，而不使用小程序级/页面级默认登录交互，提高用户登录意愿
        //...
      }
    }
  });
</code></pre>
<p>可配项详见：<a href="BaseLogin.html#login">BaseLogin#login</a>、<a href="LoginPlugin.html#requestWithLogin">LoginPlugin#requestWithLogin</a></p>
<h3>实现其它登录方式</h3>
<p>除了微信登录，也支持实现其它登录方式，如：账号密码登录、手机号验证码登录等。</p>
<ol>
<li>编写登录方式对应的鉴权模块<br>
继承<a href="BaseAuth.html">BaseAuth</a>类，编写对应的鉴权逻辑。</li>
<li>小程序中配置对应鉴权映射<br>
在appPlugin.js中loginCenter.config时，authEngineMap选项中添加相应的键值对。</li>
<li>登录界面中收集相应信息<br>
登录界面中返回相应的authType和authData。</li>
</ol>
<p>登录界面可以同时展示多种登录方式，然后根据用户交互返回用户实际所选登录方式对应的authType和authData。</p>
<h3>api查询</h3>
<ul>
<li><a href="./BaseLogin.html">登录模块-基类 BaseLogin</a></li>
<li><a href="./BaseAuth.html">鉴权模块-基类 BaseAuth</a></li>
<li><a href="./WechatAuth.html">鉴权模块-微信登录 WechatAuth</a></li>
<li><a href="./Requester.html">请求管理 Requester</a></li>
<li><a href="./LoginPlugin.html">请求管理-登录插件 LoginPlugin</a></li>
<li><a href="./CookiePlugin.html">请求管理-Cookie插件 CookiePlugin</a></li>
<li><a href="./Cookie.html">cookie管理 Cookie</a></li>
</ul>
</article>

</section>

    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.3</a> on Tue Mar 30 2021 10:06:06 GMT+0800 (中国标准时间) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>

<script src="scripts/search.js" defer></script>



</body>
</html>